<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
<!-- Header -->
<div style="background: #fff; padding: 15px 30px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
    <h1 style="margin: 0;">PTIT CINEMA - Admin Dashboard</h1>
    <div>
        <span id="admin-name" style="margin-right: 15px;">Admin</span>
        <button onclick="logout()" class="btn" style="background: #e74c3c;">Đăng xuất</button>
    </div>
</div>

<!-- Stats -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
    <div class="container" style="text-align: center;">
        <h3 id="total-users" style="font-size: 32px; margin-bottom: 10px;">0</h3>
        <p>Tổng Users</p>
    </div>
    <div class="container" style="text-align: center;">
        <h3 id="total-admins" style="font-size: 32px; margin-bottom: 10px;">0</h3>
        <p>Tổng Admins</p>
    </div>
    <div class="container" style="text-align: center;">
        <h3 id="active-users" style="font-size: 32px; margin-bottom: 10px;">0</h3>
        <p>Users Hoạt động</p>
    </div>
</div>

<!-- Thêm Admin -->
<div class="container">
    <h2>Thêm Admin Mới</h2>
    <form id="addAdminForm">
        <div class="input-group">
            <input type="text" id="username" placeholder="Tên đăng nhập" required>
        </div>
        <div class="input-group">
            <input type="email" id="email" placeholder="Email" required>
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="Mật khẩu" required>
        </div>
        <button type="submit" class="btn">Tạo Admin</button>
        <div id="adminFormMessage" class="message"></div>
    </form>
</div>

<!-- Danh sách Users -->
<div class="container">
    <h2>Quản Lý Users</h2>
    <div style="margin-bottom: 15px;">
        <input type="text" id="searchUsers" placeholder="Tìm kiếm user..." style="width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <button onclick="searchUsers()" class="btn">Tìm kiếm</button>
        <button onclick="loadUsers()" class="btn">Tải lại</button>
    </div>
    <table id="usersTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="5">Đang tải...</td></tr>
        </tbody>
    </table>
</div>

<!-- Danh sách Admins -->
<div class="container">
    <h2>Quản Lý Admins</h2>
    <div style="margin-bottom: 15px;">
        <input type="text" id="searchAdmins" placeholder="Tìm kiếm admin..." style="width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <button onclick="searchAdmins()" class="btn">Tìm kiếm</button>
        <button onclick="loadAdmins()" class="btn">Tải lại</button>
    </div>
    <table id="adminsTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="4">Đang tải...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let allUsers = [];
    let allAdmins = [];
    let filteredUsers = [];
    let filteredAdmins = [];

    // Check auth on load
    window.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const adminId = params.get('adminId');

        if (!adminId) {
            alert('Bạn cần đăng nhập với tài khoản Admin!');
            window.location.href = '/user/login';
            return;
        }

        sessionStorage.setItem('adminId', adminId);
        const adminName = sessionStorage.getItem('adminName') || 'Admin';
        document.getElementById('admin-name').textContent = adminName;

        loadUsers();
        loadAdmins();
    });

    function logout() {
        if (confirm('Bạn có chắc muốn đăng xuất?')) {
            sessionStorage.clear();
            window.location.href = '/user/login';
        }
    }

    // Load Users
    async function loadUsers() {
        try {
            const response = await fetch("http://localhost:8080/admin/users");
            const result = await response.json();

            console.log("Users:", result);

            if (result.status === "Success" && result.data?.data) {
                allUsers = result.data.data;
                filteredUsers = [...allUsers];
                updateStats();
                renderUsers();
            } else {
                document.querySelector("#usersTable tbody").innerHTML =
                    `<tr><td colspan="5">Lỗi: ${result.message || 'Không thể tải dữ liệu'}</td></tr>`;
            }
        } catch (error) {
            console.error("Error:", error);
            document.querySelector("#usersTable tbody").innerHTML =
                `<tr><td colspan="5">Lỗi kết nối: ${error.message}</td></tr>`;
        }
    }

    // Load Admins
    async function loadAdmins() {
        try {
            const response = await fetch("http://localhost:8080/admin/admins");
            const result = await response.json();

            console.log("Admins:", result);

            if (result.status === "Success" && result.data?.data) {
                allAdmins = result.data.data;
                filteredAdmins = [...allAdmins];
                updateStats();
                renderAdmins();
            } else {
                document.querySelector("#adminsTable tbody").innerHTML =
                    `<tr><td colspan="4">Lỗi: ${result.message || 'Không thể tải dữ liệu'}</td></tr>`;
            }
        } catch (error) {
            console.error("Error:", error);
            document.querySelector("#adminsTable tbody").innerHTML =
                `<tr><td colspan="4">Lỗi kết nối: ${error.message}</td></tr>`;
        }
    }

    // Search Users
    function searchUsers() {
        const term = document.getElementById('searchUsers').value.toLowerCase().trim();
        if (!term) {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(u =>
                u.username.toLowerCase().includes(term) ||
                u.email.toLowerCase().includes(term) ||
                u.userId.toString().includes(term)
            );
        }
        renderUsers();
    }

    // Search Admins
    function searchAdmins() {
        const term = document.getElementById('searchAdmins').value.toLowerCase().trim();
        if (!term) {
            filteredAdmins = [...allAdmins];
        } else {
            filteredAdmins = allAdmins.filter(a =>
                a.username.toLowerCase().includes(term) ||
                a.email.toLowerCase().includes(term) ||
                a.userId.toString().includes(term)
            );
        }
        renderAdmins();
    }

    // Render Users
    function renderUsers() {
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = '';

        if (filteredUsers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Không tìm thấy user nào</td></tr>';
            return;
        }

        filteredUsers.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.state}</td>
                    <td>
                        <button class="btn btn-lock" onclick="lockUser(${user.userId})">Khóa</button>
                        <button class="btn btn-unlock" onclick="unlockUser(${user.userId})">Mở</button>
                        <button class="btn btn-promote" onclick="promoteUser(${user.userId})">Nâng cấp</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    // Render Admins
    function renderAdmins() {
        const tbody = document.querySelector("#adminsTable tbody");
        tbody.innerHTML = '';

        if (filteredAdmins.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">Không tìm thấy admin nào</td></tr>';
            return;
        }

        filteredAdmins.forEach(admin => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${admin.userId}</td>
                    <td>${admin.username}</td>
                    <td>${admin.email}</td>
                    <td>
                        <button class="btn btn-lock" onclick="demoteUser(${admin.userId})">Giáng cấp</button>
                    </td>
                `;
            tbody.appendChild(row);
        });
    }

    // Update Stats
    function updateStats() {
        document.getElementById('total-users').textContent = allUsers.length;
        document.getElementById('total-admins').textContent = allAdmins.length;
        const active = allUsers.filter(u => u.state === 'ACTIVE').length;
        document.getElementById('active-users').textContent = active;
    }

    // Add Admin
    document.getElementById('addAdminForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        try {
            const response = await fetch("http://localhost:8080/admin/newad", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, email, password })
            });

            const result = await response.json();

            const msgEl = document.getElementById('adminFormMessage');
            msgEl.textContent = result.message;
            msgEl.className = 'message ' + (result.status === 'Success' ? 'success' : 'error');

            if (result.status === "Success") {
                document.getElementById('addAdminForm').reset();
                loadAdmins();
            }
        } catch (error) {
            const msgEl = document.getElementById('adminFormMessage');
            msgEl.textContent = 'Lỗi: ' + error.message;
            msgEl.className = 'message error';
        }
    });

    // Actions
    async function lockUser(userId) {
        if (!confirm('Khóa user này?')) return;
        await doAction(`http://localhost:8080/admin/users/lock/${userId}`, 'PUT');
    }

    async function unlockUser(userId) {
        if (!confirm('Mở khóa user này?')) return;
        await doAction(`http://localhost:8080/admin/users/unlock/${userId}`, 'PUT');
    }

    async function promoteUser(userId) {
        if (!confirm('Nâng cấp user này thành admin?')) return;
        await doAction(`http://localhost:8080/admin/users/promote/${userId}`, 'PUT');
    }

    async function demoteUser(userId) {
        if (!confirm('Giáng cấp admin này thành user?')) return;
        await doAction(`http://localhost:8080/admin/users/demote/${userId}`, 'PUT');
    }

    async function doAction(url, method) {
        try {
            const response = await fetch(url, { method });
            const result = await response.json();
            alert(result.message);
            loadUsers();
            loadAdmins();
        } catch (error) {
            alert('Lỗi: ' + error.message);
        }
    }

    // Enter key search
    document.getElementById('searchUsers').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchUsers();
    });
    document.getElementById('searchAdmins').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchAdmins();
    });
</script>
</body>
</html>